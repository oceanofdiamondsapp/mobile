var app=angular.module("app",["ui.router","ngAnimate","ngResource","ngCordova","ct.ui.router.extras","controllers","services","filters"]),controllers=angular.module("controllers",[]),services=angular.module("services",[]),filters=angular.module("filters",[]);app.constant("STONES",{1:{description:"Diamond"},2:{description:"Ruby"},3:{description:"Sapphire"},4:{description:"Emerald"}}),app.constant("METALS",{1:{description:"Silver"},2:{description:"Yellow Gold"},3:{description:"Rose Gold"},4:{description:"White Gold"},5:{description:"Platinum"}}),app.constant("API_IP","http://104.131.116.54"),app.constant("API_BASE_URL","http://104.131.116.54/api/v1"),app.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("tour",{url:"/tour",templateUrl:"partials/tour/layout.html",controller:"AppController",abstract:!0,protected:!1}).state("tour.inspiration",{url:"/inspiration",templateUrl:"partials/tour/inspiration.html",protected:!1}).state("tour.make-it-yours",{url:"/make-it-yours",templateUrl:"partials/tour/make-it-yours.html",protected:!1}).state("tour.quote",{url:"/quote",templateUrl:"partials/tour/quote.html",protected:!1}).state("tour.checkout",{url:"/checkout",templateUrl:"partials/tour/checkout.html",protected:!1}).state("tour.extras",{url:"/extras",templateUrl:"partials/tour/extras.html",controller:"AppController",protected:!1}).state("auth",{url:"/auth",templateUrl:"partials/auth/layout.html",controller:"AppController",abstract:!0,protected:!1}).state("auth.signup",{url:"/signup",templateUrl:"partials/auth/signup.html",controller:"SignupController",protected:!1}).state("auth.login",{url:"/login",templateUrl:"partials/auth/login.html",controller:"LoginController",protected:!1}).state("app",{url:"/",templateUrl:"partials/layout.html",controller:"AppController",protected:!0}).state("app.create-job",{url:"jobs/create",deepStateRedirect:!1,sticky:!0,views:{"view-create-job@app":{templateUrl:"partials/jobs/create/layout.html",controller:"CreateJobController"}},protected:!0}).state("app.create-job.start",{url:"/start",templateUrl:"partials/jobs/create/start.html",protected:!0}).state("app.create-job.details",{url:"/details",templateUrl:"partials/jobs/create/details.html",protected:!0}).state("app.create-job.review",{url:"/review",templateUrl:"partials/jobs/create/review.html",protected:!0}).state("app.create-job.thanks",{url:"/thank-you",templateUrl:"partials/jobs/create/thanks.html",protected:!0}).state("app.jobs",{url:"jobs",deepStateRedirect:!1,sticky:!0,views:{"view-jobs@app":{templateUrl:"partials/jobs/layout.html",controller:"JobsController"}},protected:!0}).state("app.jobs.all",{url:"/",templateUrl:"partials/jobs/all.html",controller:"JobsController",protected:!0}).state("app.jobs.show",{url:"/:id",templateUrl:"partials/jobs/show.html",controller:"JobDetailController",protected:!0}).state("app.jobs.quote",{url:"/:job_id/quotes/:quote_id",templateUrl:"partials/quotes/show.html",controller:"QuoteController",protected:!0}).state("app.jobs.quote-decline",{url:"/:job_id/quotes/:quote_id/decline",templateUrl:"partials/quotes/decline.html",controller:"QuoteController",protected:!0}).state("app.jobs.quote-purchase",{url:"/:job_id/quotes/:quote_id/purchase",templateUrl:"partials/quotes/purchase.html",controller:"PurchaseController",protected:!0}).state("app.jobs.quote-purchase-thanks",{url:"/purchase/thank-you",templateUrl:"partials/quotes/thanks.html",controller:"PurchaseController",protected:!0}).state("app.orders",{url:"orders",deepStateRedirect:!1,sticky:!0,views:{"view-orders@app":{templateUrl:"partials/orders/layout.html",controller:"OrdersController"}},protected:!0}).state("app.orders.all",{url:"/",templateUrl:"partials/orders/all.html",controller:"OrdersController",protected:!0}).state("app.orders.show",{url:"/:id",templateUrl:"partials/orders/show.html",controller:"OrderDetailController",protected:!0}).state("app.account",{url:"account",deepStateRedirect:!1,sticky:!0,views:{"view-account@app":{templateUrl:"partials/account/layout.html",controller:"AccountController"}},protected:!0}).state("app.account.overview",{url:"/",templateUrl:"partials/account/overview.html",controller:"AccountController",protected:!0}).state("app.account.edit",{url:"/edit",templateUrl:"partials/account/edit.html",controller:"AccountController",protected:!0}).state("app.diamond-education",{url:"diamond-education",views:{"view-page@app":{templateUrl:"partials/pages/diamond-education.html"}},protected:!0}).state("app.contact",{url:"contact",views:{"view-page@app":{templateUrl:"partials/pages/contact.html"}},protected:!0}).state("app.about",{url:"about",views:{"view-page@app":{templateUrl:"partials/pages/about.html"}},protected:!0}).state("app.return-policy",{url:"return-policy",views:{"view-page@app":{templateUrl:"partials/pages/return-policy.html"}},protected:!0}).state("app.privacy-policy",{url:"privacy-policy",views:{"view-page@app":{templateUrl:"partials/pages/privacy-policy.html"}},protected:!0}).state("app.gallery",{url:"gallery",views:{"view-page@app":{templateUrl:"partials/pages/gallery.html",controller:"AppController"}},protected:!0}).state("modals",{url:"/modals",templateUrl:"partials/pages/modal.html",abstract:!0,protected:!1}).state("modals.privacy-policy",{url:"/privacy-policy",templateUrl:"partials/pages/privacy-policy.html",protected:!1}).state("modals.return-policy",{url:"/return-policy",templateUrl:"partials/pages/return-policy.html",protected:!1}),b.otherwise("/")}]),app.run(["$rootScope","$state","$animate","$timeout","$window","$location","$http","$templateCache","$deepStateRedirect","$cordovaPushV5","API_BASE_URL",function(a,b,c,d,e,f,g,h,i,j,k){a.$state=b,a.navIsVisible=!0,document.addEventListener("deviceready",function(){var b=!!angular.fromJson(localStorage.user),c=(window.localStorage.pn_reg_id,{android:{senderID:"355956398580",forceShow:!0},ios:{alert:!0,badge:!0,sound:!0,clearBadge:!0}});window.PushNotification&&(j.initialize(c).then(function(){j.onNotification(),j.onError(),j.register().then(function(a){b||(window.localStorage.pn_reg_id=a),console.log("pn_reg_id: "+a)})}),a.$on("$cordovaPushV5:notificationReceived",function(a,b){}),a.$on("$cordovaPushV5:errorOcurred",function(a,b){alert(b.message)}))},!1),a.$on("$stateChangeStart",function(b,c){switch(window.scrollTo(0,0),c.name){case"tour.inspiration":a.pageTour=0;break;case"tour.make-it-yours":a.pageTour=1;break;case"tour.quote":a.pageTour=2;break;case"tour.checkout":a.pageTour=3;break;case"tour.extras":a.pageTour=4}var d=angular.fromJson(localStorage.user)||null,e=localStorage.doneSplash;e||"app"!=c.name?!d&&c.protected&&f.path("/auth/login"):f.path("/tour/inspiration"),localStorage.authString&&(g.defaults.headers.common.Authorization=localStorage.authString),a.navIsVisible="app"==c.name}),a.$on("$stateChangeSuccess",function(){setTimeout(function(){for(var a=document.querySelectorAll("input, button, select, label, textarea, a"),b=0;b<a.length;b++)FastClick.attach(a[b])},750)}),a.setAnimation=function(b){a.animation=b,setTimeout(function(){a.animation=""},350)},a.padding=function(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a},a.getDateString=function(b,c){if(!b)return"";c="undefined"==typeof c;var d=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"],e=Date.parse(b),f=d[e.getMonth()]+" "+a.padding(e.getDate(),2)+(c?", ":" ")+e.getFullYear();return f},a.isValidEmail=function(a){return/^([\w]+(?:\.[\w]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/.test(a)},a.isURL=function(a){if(!a)return!1;var b=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i");return b.test(a)},a.$on("userLoggedOut",function(){a.lo_loading||(a.lo_loading=!0,g.post(k+"/auth/logout",{device_id:window.device?device.uuid:null}).error(function(a){}).success(function(a){}).finally(function(){a.lo_loading=!1,g.defaults.headers.common.Authorization="",i.reset("app.create-job"),i.reset("app.jobs"),i.reset("app.orders"),i.reset("app.account");for(key in localStorage)"doneSplash"!==key&&"pn_reg_id"!=key&&delete localStorage[key];a.setAnimation("slide-back"),b.go("auth.login")}))})}]),app.filter("reverse",function(){return function(a){return a.slice().reverse()}}),controllers.controller("AppController",["$scope","$rootScope","$state",function(a,b,c){a.pageClass=["panel-tour-darkblue","panel-tour-blue","panel-tour-darkgreen","panel-tour-green","panel-tour-red"],a.galleryImages=new Array(25),a.launchReturnPolicyModal=function(){window.open("#/modals/return-policy","_blank","location=no")},a.launchPrivacyPolicyModal=function(){window.open("#/modals/privacy-policy","_blank","location=no")},a.onCloseSplash=function(){localStorage.doneSplash=!0},document.addEventListener("backbutton",function(){"auth.login"!==c.current.name&&"app"!==c.current.name&&window.history.go(-1)})}]),controllers.controller("AccountController",["$rootScope","$scope","$state","$http","API_BASE_URL","notifier",function(a,b,c,d,e,f){function g(b){1==b&&a.$emit("userLoggedOut")}function h(){var a=window.atob(localStorage.authString.replace("Basic ",""));return a.substr(a.indexOf(":")+1)}"app.account"===c.current.name&&c.go("app.account.overview"),b.user=angular.fromJson(localStorage.user),b.logout=function(){navigator.notification?navigator.notification.confirm("Are you sure you want to logout?",g,"Logout",["Logout","Cancel"]):g(confirm("Are you sure you want to logout?"))},b.updatePassword=function(){b.updatingPassword=!0,d.post(e+"/accounts/"+b.user.id,{method:"_PATCH",password:b.password,password_confirmation:b.passwordConfirmation}).error(function(a){b.updatingPassword=!1,f("Unable to update your password","Error","OK")}).success(function(a){b.updatingPassword=!1,f("Your password has been updated","Success","OK");var c="Basic "+window.btoa(a.data.email+":"+b.password);d.defaults.headers.common.Authorization=c,localStorage.user=angular.toJson(a.data),localStorage.authString=c,b.password="",b.passwordConfirmation="",b.formUpdatePassword.$setPristine()})},b.updateAccount=function(){b.updatingAccount=!0,d.post(e+"/accounts/"+b.user.id,{method:"_PATCH",email:b.user.email,name:b.user.name}).error(function(a){b.updatingAccount=!1,f("Unable to update your account","Error","OK")}).success(function(a){b.updatingAccount=!1,f("Your account has been updated","Success","OK");var c="Basic "+window.btoa(a.data.email+":"+h());d.defaults.headers.common.Authorization=c,localStorage.authString=c,localStorage.user=angular.toJson(a.data)})}}]),controllers.controller("LoginController",["$rootScope","$scope","$http","$location","API_BASE_URL","notifier","device",function(a,b,c,d,e,f,g){b.user={},b.login=function(){b.loading=!0;var a=b.user.email&&b.user.password;if(!a)return b.loading=!1,f("The email and password fields are required","Error","OK");var h="Basic "+window.btoa(b.user.email+":"+b.user.password);c.defaults.headers.common.Authorization=h,c.post(e+"/auth/login",b.user).error(function(a){b.loading=!1;var c=a.error||"Unable to log you in at this time";f(c,"Error","OK")}).success(function(a){b.loading=!1,localStorage.user=angular.toJson(a.data),localStorage.authString=h,g.tokenHandler(window.localStorage.pn_reg_id),d.path("/app")})},b.onForgotPassword=function(){navigator.notification&&!b.fp_loading&&navigator.notification.prompt("Please enter your email and we'll send you a link to reset your password.",function(d){b.$apply(function(){if(1==d.buttonIndex){if(!a.isValidEmail(d.input1))return void f("Please enter a valid email.","Error","OK");b.fp_loading=!0,c.post(e+"/auth/password/email",{email:d.input1}).error(function(a){b.fp_loading=!1;var c=a.error||"Unable to send a confirmation email at this time.";f(c,"Error","OK")}).success(function(a){if(b.fp_loading=!1,a.success){var c="Confirmation email was sent successfully.";f(c,"Success","OK")}})}})},"Forgot Password")}}]),controllers.controller("SignupController",["$scope","$http","$location","API_BASE_URL","notifier","device",function(a,b,c,d,e,f){a.loading=!1,a.doesAgree=!1,a.formIsValid=function(b){return a.doesAgree&&b.$valid&&a.user.password===a.user.password_confirmation},a.signup=function(){a.loading=!0;var g=a.user.password==a.user.password_confirmation;return g?a.doesAgree?void b.post(d+"/accounts",a.user).error(function(b){a.loading=!1;var c=b.error||"Unable to create your account at this time";e(c,"Error","OK")}).success(function(d){a.loading=!1,localStorage.user=angular.toJson(d.data);var e="Basic "+window.btoa(a.user.email+":"+a.user.password);localStorage.authString=e,b.defaults.headers.common.Authorization=e,f.tokenHandler(window.localStorage.pn_reg_id),c.path("/app")}):(a.loading=!1,e("Please agree to the terms","Error","OK")):(a.loading=!1,e("Passwords do not match","Error","OK"))}}]),controllers.controller("CameraController",["$scope","notifier",function(a,b){function c(c){a.photos.push(c),localStorage.jobPhotos=angular.toJson(a.photos),b("Photo added","Success","OK")}function d(a){}a.photos=angular.fromJson(localStorage.jobPhotos)||[],a.addPhoto=function(a){if(!navigator.camera)return b("Camera is not available","Unavailable");var a="camera"==a?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY;navigator.camera.getPicture(c,d,{quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:a,allowEdit:!0,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1})}}]),controllers.controller("CreateJobController",["$rootScope","$scope","$http","$state","$deepStateRedirect","API_BASE_URL","notifier",function(a,b,c,d,e,f,g){function h(){b.job={nickname:"",metal_type_ids:[],stones:[],carat:"",budget:"",deadline:"",ship_to_state:"",notes:""},localStorage.jobPhotos&&localStorage.removeItem("jobPhotos"),b.noStones=!0,b.terms={checked:!1}}"app.create-job"===d.current.name&&d.go("app.create-job.start"),b.job={nickname:"",metal_type_ids:[],stones:[],carat:"",budget:"",deadline:"",ship_to_state:"",notes:""},b.noStones=!1,b.terms={checked:!1},b.showDetails=!1,b.toggleMetal=function(a){var c=b.job.metal_type_ids.indexOf(a);c>-1?b.job.metal_type_ids.splice(c,1):b.job.metal_type_ids.push(a)},b.toggleStone=function(a){var c=b.job.stones.indexOf(a);c>-1?b.job.stones.splice(c,1):b.job.stones.push(a),b.noStones=!1},b.clearStones=function(){b.job.stones=[],b.noStones=!0},b.submit=function(){if(b.loading=!0,!b.terms.checked)return b.loading=!1,g("Please agree to the terms.");var e=angular.fromJson(localStorage.jobPhotos);c.post(f+"/jobs",{job:b.job,photos:e}).error(function(a){b.loading=!1;var c=a.error||"Unable to create job at this time";g(c)}).success(function(c){b.loading=!1,b.job.job_number=c.data.job_number,a.setAnimation("front"),d.go("app.create-job.thanks")})},b.getBudgetString=function(a){switch(a){case"100":return"< $100";case"500":return"$100 - $500";case"1000":return"$501 - $1000";case"2000":return"$1001 - $2000";case"3000":return"$2001 - $3000";case"4000":return"$3001 - $4000";case"5000":return"$4001 - $5000";case"9999":return"> $5000"}},b.cancel=function(){h(),a.setAnimation("slide-back"),d.go("app.create-job.start")},b.onViewQuote=function(){b.showDetails=!b.showDetails},b.onNewQuote=function(){h(),a.setAnimation("slide-back")}}]),controllers.controller("JobDetailController",["$scope","$http","API_BASE_URL","API_IP","notifier",function(a,b,c,d,e){a.job=angular.fromJson(localStorage.targetJob),a.setTargetQuote=function(a){localStorage.targetQuote=angular.toJson(a)},a.sendMessage=function(){return a.sendingMessage=!0,a.message?void b.post(c+"/jobs/"+a.job.id+"/messages",{body:a.message}).error(function(b){a.sendingMessage=!1,e("Unable to send message at this time")}).success(function(b){a.sendingMessage=!1,a.job=b.data,localStorage.targetJob=angular.toJson(b.data),a.message=""}):(a.sendingMessage=!1,e("Please enter a message"))},a.getFirstPhoto=function(a){return d+a.path}}]),controllers.controller("JobsController",["$scope","$http","$state","API_BASE_URL","API_IP","notifier",function(a,b,c,d,e,f){"app.jobs"===c.current.name&&c.go("app.jobs.all"),a.jobs=[],a.loaded=!1,a.API_IP=e,b.get(d+"/jobs").error(function(a){f("Unable to retrieve your jobs at this time")}).success(function(b){a.jobs=b.data,a.loaded=!0}),a.setTargetJob=function(a){localStorage.targetJob=angular.toJson(a)},a.getFirstPhoto=function(a){return e+a.images[0].path}}]),controllers.controller("PhotosController",["$scope","notifier",function(a,b){a.photos=[],localStorage.jobPhotos&&(a.photos=angular.fromJson(localStorage.jobPhotos)),a.getDataUrl=function(a){return"data:image/jpeg;base64,"+a}}]),controllers.controller("OrderDetailController",["$scope","$rootScope",function(a,b){a.order=angular.fromJson(localStorage.targetOrder),a.onTapTracking=function(){b.isURL(a.order.tracking_url)&&window.open(a.order.tracking_url,"_system")}}]),controllers.controller("OrdersController",["$scope","$state","$http","API_BASE_URL","notifier",function(a,b,c,d,e){"app.orders"===b.current.name&&b.go("app.orders.all"),a.orders=[],c.get(d+"/orders").error(function(a){e("Unable to retrieve orders at this time")}).success(function(b){a.orders=b.data}),a.setTargetOrder=function(a){localStorage.targetOrder=angular.toJson(a)}}]),controllers.controller("PurchaseController",["$rootScope","$scope","$http","$location","$state","$deepStateRedirect","API_BASE_URL","notifier",function(a,b,c,d,e,f,g,h){function i(a){b.loading=!0}function j(d){c.get(g+"/quotes/"+b.quote.id+"/orders").error(function(a){b.loading=!1,h("An error occurred reloading your quote")}).success(function(c){b.loading=!1,a.last_order_number=c.data[0].order_number;var d=c.data.length>0;d&&(a.setAnimation("front"),e.go("app.jobs.quote-purchase-thanks"))})}function k(a){}b.quote=angular.fromJson(localStorage.targetQuote),b.showDetails=!1,b.purchase=function(){var a=g+"/quotes/"+b.quote.quote_number+"/checkout",c=window.open(a,"_blank","location=yes");c.addEventListener("loadstart",i),c.addEventListener("loaderror",k),c.addEventListener("exit",j)},b.onViewOrder=function(){b.showDetails=!b.showDetails}}]),controllers.controller("QuoteController",["$rootScope","$scope","$state","$http","API_BASE_URL","notifier",function(a,b,c,d,e,f){b.quote=angular.fromJson(localStorage.targetQuote),b.job=angular.fromJson(localStorage.targetJob),b.declineTypeId=null,b.decline=function(){if(b.loading=!0,null===b.declineTypeId)return b.loading=!1,f("Please select a decline reason","Oops","OK");var g=e+"/quotes/"+b.quote.id+"/decline";d.post(g,{decline_type_id:b.declineTypeId}).error(function(a){b.loading=!1;var c=a||"Unable to decline the quote at this time";f(c)}).success(function(d){b.loading=!1,a.setAnimation("slide-back"),c.go("app.jobs.all")})},b.getJewelryName=function(a){var b=["Bracelet","Brooch","Charms","Earrings","Necklace & Pendants","Rings","Wedding Bands"];return b[a-1]}}]),filters.filter("stoneDesc",["STONES",function(a){return function(b){return a[b].description}}]),filters.filter("metalDesc",["METALS",function(a){return function(b){return a[b].description}}]),services.factory("device",["$http","API_BASE_URL",function(a,b){return new function(){this.tokenHandler=function(c){window.device&&a.post(b+"/devices",{device_id:device.uuid,token:c,platform:device.platform})},this.errorHandler=function(a){alert("Push notification registration error occurred: "+a)},this.registerSuccess=function(a){},this.registerError=function(a){alert("Push notification registration error occurred")}}}]),services.factory("notifier",[function(){return function(a,b,c){navigator.notification?navigator.notification.alert(a,function(){},b,c):alert(a)}}]);